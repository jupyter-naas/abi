# =============================================================================
# ABI (Agentic Brain Infrastructure) Docker Compose Configuration
# =============================================================================
# This file defines a complete AI agent ecosystem with:
# - Multi-model AI capabilities (chat, embeddings, reasoning)
# - Knowledge graph storage (Oxigraph + SPARQL interface)
# - Agent memory persistence (PostgreSQL)
# - Workflow orchestration (Dagster)
# =============================================================================

# models:
#   gemma3:
#     model: ai/gemma3
#     context_size: 8192
#     runtime_flags:
#       - --memory=4g
#       - --cpus=2
#   embeddinggemma:
#     model: ai/embeddinggemma
#     context_size: 2048
#     runtime_flags:
#       - --memory=2g
#       - --cpus=1
#   qwen3:
#     model: ai/qwen3
#     context_size: 32768
#     runtime_flags:
#       - --memory=12g
#       - --cpus=4
 
x-abi-template: &abi_template
  build:
    context: .
    dockerfile: ./.deploy/docker/images/Dockerfile
  ports:
    - 9879:9879  # REST API endpoint - http://localhost:9879
    - 8501:8501  # Streamlit web interface - http://localhost:8501
  volumes:
    # Development volumes for hot-reload
    - ./scripts:/app/scripts
    - ./uv.lock:/app/uv.lock
    - ./config.yaml:/app/config.yaml
    - ./pyproject.toml:/app/pyproject.toml
    # - ./Makefile:/app/Makefile
    # - ./storage:/app/storage  # Local file storage
    - ./src:/app/src          # Source code
    # - ./libs:/app/libs        # Libraries
    - ./README.md:/app/README.md
    - ./.env:/app/.env
    # Cached volumes for performance
    - venv_cache:/app/.venv       # Python virtual environment cache
  environment:
    - PYTHONPATH=/app
    - POSTGRES_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
    - VECTOR_STORE_ADAPTER=qdrant
    - QDRANT_HOST=${QDRANT_HOST}
    - QDRANT_PORT=6333
  # env_file:
  #   - .env  # Load environment variables (API keys, AI_MODE, etc.)
  depends_on:
    # oxigraph:
    #   condition: service_healthy  # Wait for knowledge graph to be ready
    postgres:
      condition: service_healthy
    # qdrant:
    #   condition: service_healthy
  networks:
    - abi-network
  profiles:
    - container  # Only starts when running 'make container-up'

services:
  # -----------------------------------------------------------------------------
  # ABI Main Service - AI Agent Coordinator
  # -----------------------------------------------------------------------------
  # The core ABI application that routes between specialized AI agents
  # and coordinates multi-model conversations
  abi:
    <<: *abi_template
    command: ["uv", "run", "--no-dev", "python", "-m", "naas_abi_core.apps.api.api"]  # Start ABI application
    # models:
    #   - gemma3        # Primary conversational AI model
    #   - embeddinggemma # Text embedding model for semantic search
    #   - qwen3         # Advanced reasoning model
  
  mcp-server:
    build:
      context: .
      dockerfile: libs/naas-abi-core/naas_abi_core/apps/mcp/Dockerfile.mcp
    environment:
      - ABI_API_BASE=http://${ABI_HOST}:9879
      - ABI_API_KEY=abi
      - MCP_TRANSPORT=http
    ports:
      - 8000:8000
    networks:
      - abi-network
    profiles:
      - local

  # -----------------------------------------------------------------------------
  # PostgreSQL Database - Agent Memory & Conversation Storage
  # -----------------------------------------------------------------------------
  # Stores agent conversation history, checkpoints, and persistent memory
  # Used by LangGraph for agent state management and memory retrieval
  postgres:
    image: postgres:17-alpine  # Latest stable PostgreSQL
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB} # Database for agent conversations and memory
    ports:
      - 5432:5432  # PostgreSQL database - postgresql://abi_user:abi_password@localhost:5432/abi_memory
    volumes:
      - postgres_data:/var/lib/postgresql/data  # Persistent data storage
      - ./.deploy/docker/postgres/initdb:/docker-entrypoint-initdb.d:ro  # Bootstrap additional databases
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # Oxigraph - Knowledge Graph Database (RDF/SPARQL)
  # -----------------------------------------------------------------------------
  # Stores structured knowledge as RDF triples for semantic reasoning
  # Supports SPARQL queries for complex knowledge graph operations
  oxigraph:
    image: oxigraph/oxigraph:latest
    ports:
      - 7878:7878 # Internal port (accessed via proxy)
    volumes:
      - oxigraph_data:/data  # Persistent RDF triple storage
    command: ["serve", "--location", "/data", "--bind", "0.0.0.0:7878"]
    # healthcheck:
    #   test: ["CMD-SHELL", "curl -f http://localhost:7878/query || exit 1"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 3
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # Oxigraph Proxy - Web Interface for Knowledge Graph
  # -----------------------------------------------------------------------------
  # Nginx proxy that serves the Oxigraph admin interface
  # Provides web-based access to RDF data and SPARQL endpoint
  oxigraph-proxy:
    image: nginx:alpine
    ports:
      - 7879:80  # Oxigraph web interface - http://localhost:7878
    volumes:
      - ./.deploy/docker/oxigraph-proxy/nginx-oxigraph.conf:/etc/nginx/conf.d/default.conf:ro
      - ./.deploy/docker/oxigraph-proxy/web:/usr/share/nginx/html/web:ro
    depends_on:
      - oxigraph
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # YasGUI - SPARQL Query Interface
  # -----------------------------------------------------------------------------
  # Web-based SPARQL query editor and visualizer
  # Allows interactive exploration of the knowledge graph
  yasgui:
    image: erikap/yasgui:latest
    platform: linux/amd64  # Force x86_64 for compatibility with Apple Silicon
    ports:
      - 3000:80  # YasGUI SPARQL editor - http://localhost:3000
    environment:
      - DEFAULT_SPARQL_ENDPOINT=http://127.0.0.1:7879/query  # Points to Oxigraph via Docker network
    depends_on:
      - oxigraph
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # Dagster - Workflow Orchestration & Data Pipeline Management
  # -----------------------------------------------------------------------------
  # Manages data pipelines, asset materialization, and workflow scheduling
  # Provides web UI for monitoring and managing data operations
  dagster:
    build:
      context: .
      dockerfile: ./.deploy/docker/images/Dockerfile
    ports:
      - 3001:3001  # Dagster web UI - http://localhost:3001 (avoiding conflict with YasGUI on 3000)
    volumes:
      # - ./scripts:/app/scripts
      # - ./uv.lock:/app/uv.lock
      # - ./config.local.yaml:/app/config.yaml # We mount the config.local.yaml as it's configured to run from within the containers network.
      # - ./pyproject.toml:/app/pyproject.toml
      # - ./src:/app/src
      # - ./README.md:/app/README.md
      # - ./storage:/app/storage
      # - .env:/app/.env
      - .:/app
      - venv_cache:/app/.venv
      - dagster_home:/app/.dagster  # Dagster metadata and run history
      - ./.deploy/docker/dagster/dagster.yaml:/app/.dagster/dagster.yaml:ro
    environment:
      - ENV=local
      - PYTHONPATH=/app
      - DAGSTER_HOME=/app/.dagster
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - DAGSTER_S3_LOG_BUCKET=dagster-logs
      - MINIO_ENDPOINT_URL=http://${MINIO_HOST}:9000
      - MINIO_REGION_NAME=us-east-1
      - DAGSTER_PG_HOSTNAME=${POSTGRES_HOST}
      - DAGSTER_PG_USERNAME=${POSTGRES_USER}
      - DAGSTER_PG_PASSWORD=${POSTGRES_PASSWORD}
      - DAGSTER_PG_DB=${POSTGRES_DB}
    command:
      - /bin/bash
      - -c
      - 'uv run dagster dev --host 0.0.0.0 --port 3001 -m naas_abi_core.apps.dagster.dagster'
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # MinIO - S3-compatible Object Storage for Dagster Compute Logs
  # -----------------------------------------------------------------------------
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    command: server /data --console-address :9001
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - 9000:9000  # S3 API endpoint - http://localhost:9000
      - 9001:9001  # MinIO console - http://localhost:9001
    volumes:
      - minio_data:/data
    networks:
      - abi-network
    profiles:
      - infrastructure

  # mc container to initialize the bucket on startup
  minio-init:
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z
    depends_on:
      - minio
    entrypoint: >-
      /bin/sh -c "
      until /usr/bin/mc alias set dagster http://${MINIO_HOST}:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}; do sleep 1; done &&
      /usr/bin/mc mb -p ${MINIO_ROOT_USER}/dagster-logs || true
      "
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # RabbitMQ - Message Bus (AMQP)
  # -----------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - 5672:5672   # AMQP
      - 15672:15672 # Management UI - http://localhost:15672
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # Redis - In-memory Cache / Message Broker
  # -----------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # Redis Commander - Web UI for Redis management
  # -----------------------------------------------------------------------------
  redis-commander:
    image: rediscommander/redis-commander:latest
    ports:
      - 8082:8081  # Redis Commander UI - http://localhost:8082
    environment:
      - REDIS_HOSTS=local:redis:6379
    depends_on:
      - redis
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # Matrix (Synapse) - Federated Messaging Server
  # -----------------------------------------------------------------------------
  matrix:
    image: matrixdotorg/synapse:latest
    environment:
      SYNAPSE_SERVER_NAME: localhost
      SYNAPSE_REPORT_STATS: "no"
    ports:
      - 8008:8008  # Matrix client-server API - http://localhost:8008
      - 8448:8448  # Matrix federation API
    volumes:
      - synapse_data:/data
      - ./.deploy/docker/synapse/bootstrap.sh:/bootstrap.sh:ro
    entrypoint: ["/bin/sh", "/bootstrap.sh"]
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # Element Web - Matrix Client
  # -----------------------------------------------------------------------------
  element-web:
    image: vectorim/element-web:latest
    ports:
      - 8081:80  # Element web client - http://localhost:8081
    volumes:
      - ./.deploy/docker/element-config.json:/app/config.json:ro
    depends_on:
      - matrix
    networks:
      - abi-network
    profiles:
      - infrastructure

  # -----------------------------------------------------------------------------
  # Service Portal - Single-page navigation for all HTTP UIs
  # -----------------------------------------------------------------------------
  service-portal:
    image: nginx:alpine
    ports:
      - 8080:80  # Service portal - http://localhost:8080
    volumes:
      - ./.deploy/docker/service-portal:/usr/share/nginx/html:ro
    networks:
      - abi-network
    profiles:
      - infrastructure

# =============================================================================
# PERSISTENT VOLUMES
# =============================================================================
# Named volumes for persistent data storage across container restarts

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - 6333:6333
      - 6334:6334
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    networks:
      - abi-network
    profiles:
      - infrastructure

volumes:
  venv_cache:     # Python virtual environment cache for faster startup
  oxigraph_data:  # RDF triple store data (knowledge graph persistence)
  postgres_data:  # PostgreSQL database files (agent memory persistence)
  dagster_home:   # Dagster metadata, run history, and configuration
  qdrant_storage: # Qdrant vector store data
  minio_data:     # MinIO object storage data
  rabbitmq_data:  # RabbitMQ message bus data
  redis_data:     # Redis persistence data
  synapse_data:   # Matrix Synapse data

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================
# Custom bridge network for service-to-service communication

networks:
  abi-network:
    driver: bridge  # Default Docker bridge network for internal communication
