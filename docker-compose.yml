# =============================================================================
# ABI (Agentic Brain Infrastructure) Docker Compose Configuration
# =============================================================================
# This file defines a complete AI agent ecosystem with:
# - Multi-model AI capabilities (chat, embeddings, reasoning)
# - Knowledge graph storage (Apache Jena Fuseki + TDB2)
# - Agent memory persistence (PostgreSQL)
# - Workflow orchestration (Dagster)
# =============================================================================

# models:
#   gemma3:
#     model: ai/gemma3
#     context_size: 8192
#     runtime_flags:
#       - --memory=4g
#       - --cpus=2
#   embeddinggemma:
#     model: ai/embeddinggemma
#     context_size: 2048
#     runtime_flags:
#       - --memory=2g
#       - --cpus=1
#   qwen3:
#     model: ai/qwen3
#     context_size: 32768
#     runtime_flags:
#       - --memory=12g
#       - --cpus=4

x-abi-template: &abi_template
  build:
    context: .
    dockerfile: docker/images/Dockerfile
  ports:
    - 9879:9879  # REST API endpoint - http://localhost:9879
    - 8501:8501  # Streamlit web interface - http://localhost:8501
  volumes:
    # Development volumes for hot-reload
    - .:/app
    # - ./scripts:/app/scripts
    # - ./uv.lock:/app/uv.lock
    # - ./config.yaml:/app/config.yaml
    # - ./pyproject.toml:/app/pyproject.toml
    # - ./Makefile:/app/Makefile
    # - ./storage:/app/storage  # Local file storage
    # - ./src:/app/src          # Source code
    # - ./libs:/app/libs        # Libraries
    # - ./README.md:/app/README.md
    # - ./.env:/app/.env
    # Cached volumes for performance
    - venv_cache:/app/.venv       # Python virtual environment cache
  environment:
    - ENV=local
    - LOG_LEVEL=DEBUG
    - PYTHONPATH=/app
    - POSTGRES_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:${POSTGRES_PORT}/${POSTGRES_DB}
    - VECTOR_STORE_ADAPTER=qdrant
    - QDRANT_HOST=qdrant
    - QDRANT_PORT=${QDRANT_PORT}
  # env_file:
  #   - .env  # Load environment variables (API keys, AI_MODE, etc.)
  depends_on:
    postgres:
      condition: service_healthy
    rabbitmq:
      condition: service_healthy
    qdrant:
      condition: service_healthy
    redis:
      condition: service_healthy
    fuseki:
      condition: service_healthy
    minio:
      condition: service_healthy
  healthcheck:
    test: ["CMD-SHELL", "for i in 1 2 3; do curl -fsS http://localhost:9879/ >/dev/null || exit 1; sleep 2; done"]
    interval: 10s
    timeout: 15s
    start_period: 30s
    retries: 10
  networks:
    - abi-network

services:
  nexus-web:
    build:
      context: libs/naas-abi/naas_abi/apps/nexus/
      dockerfile: Dockerfile
    ports:
      - 3042:3000
    volumes:
      - ./libs/naas-abi/naas_abi/apps/nexus/apps/web:/app/apps/web
    environment:
      - NODE_ENV=development
      - PORT=3000
      - NEXT_PUBLIC_NEXUS_ENV=local
      - NEXUS_API_URL=localhost:9879
      - NEXT_PUBLIC_API_URL=${PUBLIC_API_SCHEME:-http}://${PUBLIC_API_HOST:-api.localhost}
      - NEXT_PUBLIC_WS_PATH=/ws/socket.io
    networks:
      - abi-network

  caddy:
    image: caddy:2-alpine
    ports:
      - 80:80
      - 443:443
    environment:
      - PUBLIC_WEB_HOST=${PUBLIC_WEB_HOST:-localhost}
      - PUBLIC_API_HOST=${PUBLIC_API_HOST:-api.localhost}
    volumes:
      - ./docker/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - nexus-web
      - abi
    networks:
      - abi-network
  # -----------------------------------------------------------------------------
  # ABI Main Service - AI Agent Coordinator
  # -----------------------------------------------------------------------------
  # The core ABI application that routes between specialized AI agents
  # and coordinates multi-model conversations
  abi:
    <<: *abi_template
    command: ["uv", "run", "--no-dev", "python", "-m", "naas_abi_core.apps.api.api"]  # Start ABI application
    # models:
    #   - gemma3        # Primary conversational AI model
    #   - embeddinggemma # Text embedding model for semantic search
    #   - qwen3         # Advanced reasoning model
  
  mcp-server:
    build:
      context: .
      dockerfile: libs/naas-abi-core/naas_abi_core/apps/mcp/Dockerfile.mcp
    depends_on:
      abi:
        condition: service_healthy
    environment:
      - ABI_API_BASE=http://abi:9879
      - ABI_API_KEY=abi
      - MCP_TRANSPORT=http
    ports:
      - 8000:8000
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # PostgreSQL Database - Agent Memory & Conversation Storage
  # -----------------------------------------------------------------------------
  # Stores agent conversation history, checkpoints, and persistent memory
  # Used by LangGraph for agent state management and memory retrieval
  postgres:
    image: postgres:17-alpine  # Latest stable PostgreSQL
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB} # Database for agent conversations and memory
    ports:
      - ${POSTGRES_PORT}:${POSTGRES_PORT}  # PostgreSQL database - postgresql://abi_user:abi_password@localhost:${POSTGRES_PORT}/abi_memory
    volumes:
      - postgres_data:/var/lib/postgresql/data  # Persistent data storage
      - ./docker/postgres/initdb:/docker-entrypoint-initdb.d:ro  # Bootstrap additional databases
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # Apache Jena Fuseki (TDB2) - Knowledge Graph Database (RDF/SPARQL)
  # -----------------------------------------------------------------------------
  # Stores structured knowledge as RDF triples for semantic reasoning
  # TDB2 provides transactional storage with SPARQL query/update endpoints
  fuseki:
    image: stain/jena-fuseki:latest
    ports:
      - 3030:3030
    volumes:
      - fuseki_data:/fuseki
    environment:
      - ADMIN_PASSWORD=${FUSEKI_ADMIN_PASSWORD}
      - FUSEKI_DATASET_1=ds
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3030/ >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # YasGUI - SPARQL Query Interface
  # -----------------------------------------------------------------------------
  # Web-based SPARQL query editor and visualizer
  # Allows interactive exploration of the knowledge graph
  yasgui:
    image: erikap/yasgui:latest
    platform: linux/amd64  # Force x86_64 for compatibility with Apple Silicon
    ports:
      - 3000:80  # YasGUI SPARQL editor - http://localhost:3000
    environment:
      - DEFAULT_SPARQL_ENDPOINT=http://fuseki:3030/ds/query
    depends_on:
      - fuseki
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # Dagster - Workflow Orchestration & Data Pipeline Management
  # -----------------------------------------------------------------------------
  # Manages data pipelines, asset materialization, and workflow scheduling
  # Provides web UI for monitoring and managing data operations
  dagster:
    build:
      context: .
      dockerfile: docker/images/Dockerfile
    ports:
      - 3001:3001  # Dagster web UI - http://localhost:3001 (avoiding conflict with YasGUI on 3000)
    volumes:
      #- ./scripts:/app/scripts
        # - ./uv.lock:/app/uv.lock
      #- ./pyproject.toml:/app/pyproject.toml
      #- ./src:/app/src
      #- ./lib:/app/lib
      #- ./libs:/app/libs
      #- ./README.md:/app/README.md
      #- ./storage:/app/storage
      #- .env:/app/.env
      - .:/app/
      - venv_cache:/app/.venv
      - dagster_home:/app/.dagster  # Dagster metadata and run history
      - ./docker/dagster/dagster.yaml:/app/.dagster/dagster.yaml:ro
    environment:
      - ENV=local
      - PYTHONPATH=/app
      - DAGSTER_HOME=/app/.dagster
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
      - DAGSTER_S3_LOG_BUCKET=dagster-logs
      - MINIO_ENDPOINT_URL=http://minio:${MINIO_PORT}
      - MINIO_REGION_NAME=us-east-1
      - DAGSTER_PG_HOSTNAME=postgres
      - DAGSTER_PG_USERNAME=${POSTGRES_USER}
      - DAGSTER_PG_PASSWORD=${POSTGRES_PASSWORD}
      - DAGSTER_PG_DB=${POSTGRES_DB}
    command:
      - /bin/bash
      - -c
      - 'uv run dagster dev --host 0.0.0.0 --port 3001 -m naas_abi_core.apps.dagster.dagster'
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # MinIO - S3-compatible Object Storage for Dagster Compute Logs
  # -----------------------------------------------------------------------------
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    command: server /data --console-address :9001
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - ${MINIO_PORT}:${MINIO_PORT}  # S3 API endpoint - http://localhost:${MINIO_PORT}
      - 9001:9001  # MinIO console - http://localhost:9001
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9000/minio/health/live >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - abi-network

  # mc container to initialize the bucket on startup
  minio-init:
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >-
      /bin/sh -c "
      until /usr/bin/mc alias set ${MINIO_ROOT_USER} http://minio:${MINIO_PORT} ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}; do sleep 1; done &&
      /usr/bin/mc mb -p ${MINIO_ROOT_USER}/dagster-logs || true &&
      /usr/bin/mc mb -p ${MINIO_ROOT_USER}/abi || true
      "
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # RabbitMQ - Message Bus (AMQP)
  # -----------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - 5672:5672   # AMQP
      - 15672:15672 # Management UI - http://localhost:15672
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 10
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # Redis - In-memory Cache / Message Broker
  # -----------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # Redis Commander - Web UI for Redis management
  # -----------------------------------------------------------------------------
  redis-commander:
    image: rediscommander/redis-commander:latest
    ports:
      - 8082:8081  # Redis Commander UI - http://localhost:8082
    environment:
      - REDIS_HOSTS=local:redis:${REDIS_PORT}
    depends_on:
      - redis
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # Matrix (Synapse) - Federated Messaging Server
  # -----------------------------------------------------------------------------
  matrix:
    image: matrixdotorg/synapse:latest
    environment:
      SYNAPSE_SERVER_NAME: localhost
      SYNAPSE_REPORT_STATS: "no"
    ports:
      - 8008:8008  # Matrix client-server API - http://localhost:8008
      - 8448:8448  # Matrix federation API
    volumes:
      - synapse_data:/data
      - ./docker/synapse/bootstrap.sh:/bootstrap.sh:ro
    entrypoint: ["/bin/sh", "/bootstrap.sh"]
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # Element Web - Matrix Client
  # -----------------------------------------------------------------------------
  element-web:
    image: vectorim/element-web:latest
    ports:
      - 8081:80  # Element web client - http://localhost:8081
    volumes:
      - ./docker/element-config.json:/app/config.json:ro
    depends_on:
      - matrix
    networks:
      - abi-network

  # -----------------------------------------------------------------------------
  # Service Portal - Single-page navigation for all HTTP UIs
  # -----------------------------------------------------------------------------
  service-portal:
    image: nginx:alpine
    ports:
      - 8080:80  # Service portal - http://localhost:8080
    environment:
      - PUBLIC_WEB_HOST=${PUBLIC_WEB_HOST:-localhost}
      - PUBLIC_API_HOST=${PUBLIC_API_HOST:-api.localhost}
      - NGINX_ENVSUBST_TEMPLATE_DIR=/usr/share/nginx/templates
      - NGINX_ENVSUBST_TEMPLATE_SUFFIX=.template
      - NGINX_ENVSUBST_OUTPUT_DIR=/usr/share/nginx/html
    volumes:
      - ./docker/service-portal:/usr/share/nginx/templates:ro
    networks:
      - abi-network

# =============================================================================
# PERSISTENT VOLUMES
# =============================================================================
# Named volumes for persistent data storage across container restarts

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - 6333:6333
      - 6334:6334
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "bash -ec 'exec 3<>/dev/tcp/127.0.0.1/6333'"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - abi-network

volumes:
  venv_cache:     # Python virtual environment cache for faster startup
  fuseki_data:    # RDF triple store data (knowledge graph persistence)
  postgres_data:  # PostgreSQL database files (agent memory persistence)
  dagster_home:   # Dagster metadata, run history, and configuration
  qdrant_storage: # Qdrant vector store data
  minio_data:     # MinIO object storage data
  rabbitmq_data:  # RabbitMQ message bus data
  redis_data:     # Redis persistence data
  synapse_data:   # Matrix Synapse data
  caddy_data:     # Caddy certificates and ACME data
  caddy_config:   # Caddy runtime configuration

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================
# Custom bridge network for service-to-service communication

networks:
  abi-network:
    driver: bridge  # Default Docker bridge network for internal communication
